package de.tyrannus.venomhack.modules.exploit;

import de.tyrannus.venomhack.events.ItemUseEvent;
import de.tyrannus.venomhack.events.KeyEvent;
import de.tyrannus.venomhack.events.PacketEvent;
import de.tyrannus.venomhack.modules.Module;
import de.tyrannus.venomhack.modules.Modules;
import de.tyrannus.venomhack.modules.movement.InventoryWalk;
import de.tyrannus.venomhack.utils.MathUtil;
import meteordevelopment.orbit.EventHandler;
import net.minecraft.item.ChorusFruitItem;
import net.minecraft.network.Packet;
import net.minecraft.network.packet.s2c.play.PlayerPositionLookS2CPacket;

public class ChorusControl extends Module {
   private PlayerPositionLookS2CPacket posPacket;
   private boolean eating = false;

   public ChorusControl() {
      super(Module.Categories.EXPLOIT, "chorus-control", "Delays teleport from chorus flowers until you press sneak.");
   }

   @EventHandler
   private void onPacketReceive(PacketEvent.Receive event) {
      if (mc.player != null) {
         if (this.eating) {
            Packet var3 = event.getPacket();
            if (var3 instanceof PlayerPositionLookS2CPacket packet) {
               this.posPacket = packet;
               this.eating = false;
               this.info(
                  "teleporting to X: "
                     + MathUtil.round(packet.getX(), 1)
                     + " Y: "
                     + MathUtil.round(packet.getY(), 1)
                     + " Z: "
                     + MathUtil.round(packet.getZ(), 1)
                     + ", "
                     + MathUtil.round(Math.sqrt(mc.player.squaredDistanceTo(packet.getX(), packet.getY(), packet.getZ())), 1)
                     + "m away."
               );
               event.cancel();
            }
         }
      }
   }

   @EventHandler
   private void onStartEating(ItemUseEvent.Start event) {
      if (event.getStack().getItem() instanceof ChorusFruitItem) {
         this.eating = true;
      }
   }

   @EventHandler
   private void onStopEating(ItemUseEvent.Stop event) {
      if (event.getStack().getItem() instanceof ChorusFruitItem) {
         this.eating = false;
      }
   }

   @EventHandler
   private void onKey(KeyEvent.Post event) {
      if (this.posPacket != null && event.matchesBind(mc.options.sneakKey) && (mc.currentScreen == null || Modules.get(InventoryWalk.class).sneak.get())) {
         this.posPacket.apply(mc.player.networkHandler);
         this.posPacket = null;
      }
   }

   @Override
   public String getArrayText() {
      return this.posPacket != null ? "Ready" : "";
   }

   @Override
   public void onDisable() {
      if (this.posPacket != null && mc.player != null) {
         this.posPacket.apply(mc.player.networkHandler);
      }

      this.eating = false;
      this.posPacket = null;
   }
}
